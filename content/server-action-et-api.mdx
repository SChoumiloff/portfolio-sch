---
title: "NextJs : Server function et API route ?"
publishedAt: "2025-02-03"
summary: "D√©couvrez les diff√©rences entre les server functions et les API routes dans Next.js, et comment choisir la bonne m√©thode pour votre application."
author: "Sacha Choumiloff"
image: "/nextjs-logo.svg"
tags: ["Next.js", "Server functions", "API Routes", "D√©veloppement Web"]
readingTime: "5 min"
---


# Next.js : Server function et API route ?
Depuis sa cr√©ation, Next.js s'est impos√© comme l'un des frameworks React les plus puissants et populaires. Mais au-del√† du simple rendu c√¥t√© serveur (SSR) ou de la g√©n√©ration statique (SSG), Next.js offre une flexibilit√© impressionnante pour la gestion des donn√©es, notamment √† travers deux m√©canismes majeurs : les API Routes et les Server Functions de React (server functions, server components, etc.).

Quand faut-il utiliser une **API route** plut√¥t qu'une **Server Function** ? Comment choisir la meilleure approche en fonction de votre besoin ? Plongeons ensemble dans ces concepts essentiels pour faire les bons choix architecturaux.

Je suis **Sacha Choumiloff**, ing√©nieur logiciel et entrepreneur. Mon objectif √† travers ces articles est de partager des outils et techniques qui pourraient vous inspirer ou vous √™tre utiles dans vos propres projets futurs.

## Qu'est-ce qu'une server function ? 

Une `server function` ou anciennement `server action` (depuis la [version 19](https://react.dev/versions) de React), est une fonction qui est ex√©cut√©e sur le serveur et invoqu√©e directement depuis un composant React, la plupart du temps suite √† une action utilisateur. Elles utilisent un m√©canisme interne bas√© sur **React Server Components** et **React Compiler** pour diff√©rencier le code ex√©cut√© c√¥t√© client et c√¥t√© serveur.
- Les **React Server Components (RSC)** ont √©t√© introduits dans la version 18 de react et permettent d'ex√©cuter certaines parties d'une application React enti√®rement c√¥t√© serveur et de les injecter dans le rendu sans jamais les envoyer au client.
- Le **React Compiler** permet de diff√©rencier le code ex√©cut√© c√¥t√© client et c√¥t√© serveur.

### Comment d√©clarer une server function ? 

Il existe deux approches principales pour d√©clarer des server functions dans Next.js :

1. **Dans des fichiers d√©di√©s** : Vous pouvez cr√©er des fichiers s√©par√©s (par exemple `actions.ts`) qui contiennent uniquement vos server functions. Cette approche favorise une meilleure organisation du code et facilite la r√©utilisation des fonctions √† travers votre application. Il suffit d'ajouter la directive `"use server"` en haut du fichier.
```tsx
"use server";

export async function maServerFunction() {
  // ... code a executer sur le serveur
}
```

2. **Directement dans les composants** : Vous pouvez √©galement d√©clarer vos server functions directement dans vos composants ou pages, en utilisant la directive `"use server"` au niveau de la fonction. Cette approche est pratique pour des fonctions sp√©cifiques √† un composant.

```tsx
export default async function MaPageForm() {
  async function handleSubmit(formData: FormData) {

    'use server'; 
    //    ... code a executer sur le serveur
  } 

  return (
    <form action={handleSubmit}>
      {' '}
      <label htmlFor="name">Nom</label>
      <input type="text" id="name" name="name" required />
      <label htmlFor="email">Email</label>
      <input type="email" id="email" name="email" required />
      <button type="submit">Cr√©er un utilisateur</button>
    </form>
  );
}
```

Les deux approches sont valides et peuvent m√™me √™tre utilis√©es simultan√©ment dans un projet. Le choix d√©pendra de :
- La r√©utilisabilit√© de vos fonctions
- L'organisation souhait√©e de votre code
- La complexit√© de votre application

## Qu'est-ce qu'une API route ? 

Une **API route** est une fonctionnalit√© de Next.js qui permet de cr√©er facilement des endpoints backend au sein m√™me de votre application. Ces routes sont ex√©cut√©es c√¥t√© serveur, ce qui signifie que leur logique n'est jamais expos√©e au client. 

### Ou sont elles d√©finies ? 

Chaque route API est d√©finie dans un fichier qu'on nomme g√©n√©ralement `route.ts` ou `route.js`. Je souhaite cr√©er une route API qui r√©cup√®re l'ensemble des produits de ma base de donn√©es ? Je vais cr√©er le fichier `app/api/produits/route.ts` et y d√©finir ma logique de r√©cup√©ration.  

### Comment g√©rer les param√®tres dynamiques (slugs) ?

Next.js permet de cr√©er des **routes API dynamiques**, facilitant l'organisation des endpoints et l'acc√®s aux donn√©es en fonction des param√®tres d'URL.  

- **1. Param√®tre simple**  
Une API Route peut inclure un **param√®tre unique** dans son chemin, permettant de r√©cup√©rer des donn√©es sp√©cifiques en fonction d'un identifiant (`id`). Pour cela on cr√©era le fichier `app/api/produits/[id]/route.ts` et on y d√©finira la logique (*[id] est un r√©pertoire dynamique*).  

- **2. Param√®tres multiples**  
Les routes API peuvent contenir **plusieurs param√®tres dynamiques**, structurant ainsi des endpoints hi√©rarchiques. Cela est utile pour organiser les donn√©es par cat√©gories ou sous-groupes. Pour cela on cr√©era le fichier `app/api/produits/[categorie]/[id]/route.ts` et on y d√©finira la logique (*[categorie] et [id] sont des r√©pertoires dynamiques*).  

- **3. Capture de tous les segments (Catch-All Routes)**  
Les routes dynamiques peuvent capturer un **nombre variable de segments d'URL** gr√¢ce aux **routes catch-all** (`[...slug]`). Cette fonctionnalit√© offre deux variantes :
- Le **catch-all obligatoire** (`[...slug]`) qui n√©cessite au moins un segment dans l'URL
- Le **catch-all optionnel** (`[[...slug]]`) qui fonctionne m√™me sans segment

Cette approche est particuli√®rement adapt√©e pour des structures hi√©rarchiques dynamiques comme des syst√®mes de documentation, des APIs de gestion de fichiers ou des URLs SEO avec une profondeur variable.

### Comment d√©finir une route API avec les diff√©rents verbes HTTP ?

Un fichier `route.ts` peut g√©rer plusieurs verbes HTTP. Par Exemple, le fichier `app/api/produits/route.ts` peut g√©rer les verbes `GET` et `POST`. Pour cela on d√©finit un handler pour chaque verbe.

```tsx
export async function GET(request: Request) {
  // ... logique pour r√©cup√©rer les produits
}

export async function POST(request: Request) {
  // ... logique pour cr√©er un produit
}
```

L'objet `request` impl√©mente l'interface **Request** de [l'API fetch](https://developer.mozilla.org/fr/docs/Web/API/Request) et contient des informations sur la requ√™te HTTP, comme les headers, le corps de la requ√™te, etc.

Chaque handler retourne un objet qui impl√©mente l'interface **Response** de [l'API fetch](https://developer.mozilla.org/fr/docs/Web/API/Response). Pour cela NextJs nous propose l'objet `NextResponse`.

```tsx
import { NextResponse } from 'next/server';

export async function GET(request: Request) {
  const produits = // r√©cup√©ration des produits
  return NextResponse.json({
    data: produits.map((produit) => ({
      id: produit.id,
      nom: produit.nom,
      prix: produit.prix,
    })),
    status: 200,
  })
}
```

## API route ou server function que choisir ?

### 1. Server functions

#### Avantages

- **Facilit√© de mise en place** : Il suffit d'un fichier avec `"use server"` pour qu'une fonction devienne une Server Functions
- **TypeScript natif** : Contrairement aux requ√™tes fetch(), les Server Functions sont automatiquement typ√©es
- **Optimisation c√¥t√© serveur** : Pas d'appel HTTP, l'ex√©cution est directe et plus performante

#### Inconv√©nients

- **Non accessible par d'autres services** : Une Server Functions ne peut pas √™tre appel√©e depuis une application mobile ou une API externe
- **Uniquement en POST** : Impossible d'exposer une API compl√®te avec plusieurs m√©thodes (GET, PUT, DELETE)
- **Fortement coupl√© √† Next.js** : Pas d'acc√®s direct √† req et res comme dans une API classique
- **Timeout limit√©** : L'ex√©cution peut √™tre interrompue si la page change ou se ferme

### 2. API Routes (app/api/)

#### Avantages

- **Plus de libert√©** : Acc√®s complet √† req et res, permettant une personnalisation avanc√©e
- **Accessible depuis n'importe o√π** : Utilisable par d'autres serveurs, applications mobiles ou services tiers
- **Support complet HTTP** : Gestion de toutes les m√©thodes HTTP (GET, POST, PUT, DELETE, etc.)

#### Inconv√©nients

- **Requiert un fetch()** : Contrairement aux Server Functions, les API Routes n√©cessitent un appel HTTP explicite
- **Moins int√©gr√© au code React** : Les API Routes sont souvent plac√©es dans un dossier /api, √©loign√© des composants React

### Comment choisir la bonne approche ?

#### Utilisez une Server Functions si :

- L'endpoint est utilis√© uniquement par votre application Next.js
- Vous voulez √©viter les requ√™tes fetch() pour un code plus propre et rapide
- Vous souhaitez optimiser les performances et √©viter d'exposer une API publique

#### Utilisez une API Route si :

- L'API doit √™tre accessible par une application mobile, un autre serveur ou un service externe
- Vous avez besoin d'un temps d'ex√©cution plus long (ex: traitement intensif, g√©n√©ration d'un fichier)
- Vous voulez une API REST compl√®te avec plusieurs m√©thodes HTTP

## Et la s√©curit√© dans tout √ßa ?

### Ai-je besoin de s√©curiser mes Server Functions ?

üí° *"Pas de souci, mon utilisateur est authentifi√© c√¥t√© client, donc mes Server Functions sont s√©curis√©es, non ?"*  

C'est une pens√©e logique‚Ä¶ mais **pas totalement vraie !**

Si une fonction s'ex√©cute **c√¥t√© serveur**, cela ne signifie pas qu'elle est **totalement prot√©g√©e**. En r√©alit√©, une Server Functions peut toujours √™tre **appel√©e directement**, tant qu'on conna√Æt son point d'acc√®s.  

#### Faisons une exp√©rience !

J'ai cr√©√© une petite application de d√©monstration pour illustrer ce probl√®me de s√©curit√©. Voici comment elle fonctionne :

1. Une page avec un formulaire de connexion qui demande un mot de passe
2. Le mot de passe est "secret123" (oui, tr√®s s√©curis√© üòÖ)
3. Une fois connect√©, un bouton permet d'acc√©der √† un "secret" via une server Functions
4. Si on n'est pas connect√©, impossible d'acc√©der au bouton pour r√©cup√©rer le secret

En apparence, tout semble s√©curis√© : sans le mot de passe, impossible d'acc√©der au secret depuis l'interface... Mais est-ce vraiment le cas ?

#### Peut-on acc√©der √† une Server Functions sans passer par l'application Next.js ?  

Oui, **une Server Functions peut √™tre d√©clench√©e en dehors de l'application**, sans m√™me avoir acc√®s √† son code source. En voici la d√©monstration :

![nextjs-server-function-response](/nextjs-server-function-connect.png)

Une fois connect√©, on acc√®de √† cette interface et on clique sur le bouton "R√©cup√©rer mon secret".

![nextjs-server-function-response](/nextjs-server-function-after-connect.png)

A chaque click, sur le bouton "R√©cup√©rer mon secret", on appelle la server Functions `getSecret` d√©clar√©e dans le fichier `actions.ts`. l'inspecteur web de chrome nous permet de voir la requ√™te envoy√©e √† l'application.

![nextjs-server-function-response](/nextjs-server-function-inspect1.png)

Si on inspecte les **requests headers**, on peut voir le header `Next-Action` qui identifie notre server Functions. Cet identifiant est g√©n√©r√© par Next.js est un hash de la fonction `getSecret`. Ce hash est unique est a √©t√© d√©finit lors de la compilation. C'est lui qui permet d'indiquer au serveur quelle fonction ex√©cuter. 

![nextjs-server-function-response](/nextjs-server-function-next-action.png)

Une fois ces informations r√©cup√©r√©es, on peut les copier dans les headers de notre requ√™te Postman.

![nextjs-server-function-response](/nextjs-server-function-postman.png)

Comme vous pouvez le voir sur cette capture d'√©cran de Postman, il est possible d'appeler directement la server Functions en contournant compl√®tement l'authentification mise en place c√¥t√© client ! 

La requ√™te est simple :
1. Une requ√™te POST vers l'URL de notre application
2. Un header sp√©cial `Next-Action` qui identifie notre server Functions
3. Et voil√†, nous avons acc√®s au secret sans jamais avoir saisi le mot de passe !

üí° **Conclusion** : Une authentification c√¥t√© client n'est jamais suffisante. Il est crucial de s√©curiser vos server Functions c√¥t√© serveur, par exemple en utilisant des sessions s√©curis√©es ou des tokens JWT.

Vous pouvez vous m√™me refaire l'exp√©rience depuis [ce lien](https://dataelevation.dev/example/server-action-security)

### Ai-je besoin de s√©curiser mes API Routes ?

La s√©curisation des API Routes dans Next.js ne diff√®re pas d'une API REST classique. Les m√™mes bonnes pratiques s'appliquent : authentification (JWT, sessions, API keys), validation des donn√©es entrantes, et gestion des autorisations.

## Conclusion

Le choix entre Server Functions et API Routes n'est pas une question de "meilleure" solution, mais plut√¥t de contexte et de besoins sp√©cifiques. Les deux approches ont leur place dans l'√©cosyst√®me Next.js et peuvent m√™me √™tre utilis√©es de mani√®re compl√©mentaire dans un m√™me projet.

### Points cl√©s √† retenir :
- Les Server Functions sont id√©ales pour les interactions rapides / mutations au sein de votre application Next.js
- Les API Routes sont pr√©f√©rables pour cr√©er des endpoints accessibles depuis l'ext√©rieur
- La s√©curit√© doit √™tre une pr√©occupation majeure, quelle que soit l'approche choisie
- Une bonne architecture peut combiner les deux approches selon les besoins

N'oubliez pas que la s√©curit√© doit toujours √™tre impl√©ment√©e c√¥t√© serveur, peu importe la m√©thode choisie.

Si vous souhaitez approfondir ces concepts, je vous invite √† consulter [la documentation officielle de Next.js](https://nextjs.org/docs) qui est r√©guli√®rement mise √† jour avec les derni√®res bonnes pratiques.


